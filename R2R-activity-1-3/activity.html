<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Activity 1.3</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap"
            rel="stylesheet"
        />

        <style>
            /* * {
                margin: 0;
                padding: 0;
                box-sizing: border-box; */
            /* } */

            body {
                font-family: "Poppins", sans-serif;
                background-color: #e6ecf0;
                /* padding: 40px 0; */
            }

            .main-activity-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                margin: 15px;
                background-color: #ffffff;
                border-radius: 10px;
                padding: 5px;
                padding-bottom: 50px;
            }
            #sticky-header {
                display: grid; /* Use CSS Grid layout */
                grid-template-columns: repeat(
                    4,
                    1fr
                ); /* Define 5 equally spaced columns */
                grid-template-rows: repeat(
                    2,
                    1fr
                ); /* Define 2 equally spaced rows */
                /* gap: 15px; Gap between grid items */
                background-color: #f4f4f4;
                width: 75vw;
                height: 185px; /* Updated height to accommodate two rows */
                margin-bottom: 40px;
                justify-items: center;
                padding: 5px;
                border-radius: 10px;
                align-items: center;
            }

            .sticky-note {
                width: 80px;
                height: 80px;
                background-color: #ffeb3b;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                text-align: center;
                box-sizing: border-box;
                padding: 5px;
                font-size: 12px;
            }

            #whiteboard {
                width: 70vw;
                /* height: 70vh; */
                height: 450px;
                /* background-color: white; */
                /* background-color: rgb(255, 246, 209); */
                position: relative;
                /* overflow: hidden; to ensure notes don't spill out */
            }

            /* whiteboard styling */
            .container {
                display: flex;
                flex-wrap: wrap;
                position: relative;
                width: 100%;
                height: 100%;
            }

            .quadrant {
                display: flex;
                flex: 1 1 50%; /* grow, shrink, base size  */
                align-items: center;
                justify-content: center;
                font-weight: bold;
                text-align: center;
            }

            .green {
                background-color: #c2e597;
            }

            .blue {
                background-color: #a5d5ff;
            }

            .grey {
                background-color: #d1d1d1;
            }

            .tan {
                background-color: #ffdaa5;
            }

            .line {
                position: absolute;
                background-color: black;
            }

            .horizontal {
                width: 104%;
                height: 2px;
                top: 50%;
                left: -2%;
                transform: translateY(-50%);
            }

            .vertical {
                width: 2px;
                height: 102%;
                top: -1%;
                left: 50%;
                transform: translateX(-50%);
            }

            .arrow {
                position: absolute;
                width: 0;
                height: 0;
                border-style: solid;
            }

            .horizontal-arrow {
                left: 50%;
                bottom: -15px;
                border-width: 10px 10px 0;
                border-color: black transparent transparent transparent;
                transform: translateX(-50%);
            }

            .vertical-arrow {
                top: 50%;
                right: -16px;
                border-width: 10px 0 10px 10px;
                border-color: transparent transparent transparent black;
                transform: translateY(-50%);
            }

            /* New arrow classes for the top and left sides */
            .arrow.horizontal-arrow-top {
                left: 50%;
                top: -17px;
                border-width: 0 10px 10px;
                border-color: transparent transparent black transparent;
                transform: translateX(-50%);
            }

            .arrow.vertical-arrow-left {
                top: 50%;
                left: -17px;
                border-width: 10px 10px 10px 0;
                border-color: transparent black transparent transparent;
                transform: translateY(-50%);
            }

            .label {
                position: absolute;
                font-weight: bold;
                z-index: 10; /* Ensure labels are on top */
            }

            .horizontal-left {
                left: -82px;
                top: 50%;
                transform: translateY(-60%);
            }

            .horizontal-right {
                right: -82px;
                top: 50%;
                transform: translateY(-60%);
            }

            .vertical-top {
                top: -35px;
                left: 50%;
                transform: translateX(-50%) translateY(-10%);
            }
            .vertical-bottom {
                bottom: -40px;
                left: 50%;
                transform: translateX(-50%) translateY(10%);
            }

            .sticky-note-placeholder {
                visibility: hidden;
            }

            button,
            input {
                /* width: 100%; */
                padding: 12px 15px;
                margin-top: 20px;
                border: none;
                background-color: #2ea44f;
                color: #fff;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.3s;

                position: absolute;
                /* bottom: 2%;
                right: 2%;
                padding: 10px 20px; */
                position: absolute;
                bottom: -30%;
                right: 4%;
                padding: 10px 10px;
            }

            button:hover {
                background-color: #21833a;
            }

            #instruction-container {
                padding: 10px;
            }
            #continue-button {
                padding: 12px 15px;
    margin-top: 20px;
    border: none;
    background-color: #2ea44f;
    color: #fff;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
    position: absolute;
    position: relative;
    bottom: -30%;
    right: -40%;
    padding: 10px 10px;
            }
        </style>
    </head>

    <body>
        <div class="main-activity-container">
            <!-- <h1>R2R Activity 1.3</h1> -->

            <div id="instruction-container">
                <!-- <h2>Think about rigor issues in your lab:</h2> -->
                <p>Think about rigor issues in your lab:</p>

                <ul>
                    <li>
                        Which issues have the biggest impact on yourself and
                        your research?
                    </li>
                    <li>Which issues are you most interested in solving?</li>
                </ul>
                <p>
                    Drag the sticky notes below to different quadrants on the
                    board to reflect your thoughts on which issues are most
                    interesting and most impactful in your lab.
                </p>
            </div>
            <div id="sticky-header"></div>
            <div id="whiteboard">
                <div class="label horizontal-left">LOW<br />IMPACT</div>
                <div class="label horizontal-right">HIGH<br />IMPACT</div>
                <div class="label vertical-top">HIGH INTEREST</div>
                <div class="label vertical-bottom">LOW INTEREST</div>
                <div class="container">
                    <div class="quadrant green">WE CARE BUT LOW IMPACT</div>
                    <div class="quadrant blue">WE CARE AND BIG IMPACT</div>
                    <div class="quadrant grey">DON'T DO IT</div>
                    <div class="quadrant tan">BIG IMPACT BUT DON'T CARE</div>
                    <div class="line horizontal"></div>
                    <div class="line vertical"></div>
                    <div class="arrow horizontal-arrow"></div>
                    <div class="arrow vertical-arrow"></div>
                    <div class="arrow horizontal-arrow-top"></div>
                    <div class="arrow vertical-arrow-left"></div>
                </div>
            </div>
            <button id="continue-button">Continue</button>
        </div>

        <script>
            // Data structure to store note scores and text
            let noteScores = {
                "Missed mistakes": { impact: 0, interest: 0 },
                "Interpreting results": { impact: 0, interest: 0 },
                "Designing experiments": { impact: 0, interest: 0 },
                "Hard to reproduce analyses": { impact: 0, interest: 0 },
                "Hard to find files": { impact: 0, interest: 0 },
                "Data loss or corruption": { impact: 0, interest: 0 },
                "Deviating from lab protocols": { impact: 0, interest: 0 },
                "Difficult onboarding and offboarding": {
                    impact: 0,
                    interest: 0,
                },
            };

            // use for hardcoded session ID testing
            // const currentSessionID = 886254;

            // Get the current session ID from the URL
            const urlParams = new URLSearchParams(window.location.search);
            let currentSessionID = urlParams.get("sessionId");

            // Convert to integer with error handling
            try {
                currentSessionID = parseInt(currentSessionID);
                if (isNaN(currentSessionID)) {
                    console.log(
                        "currentSessionID non alert: ",
                        currentSessionID
                    );
                    alert(
                        "No session ID found. Please return to the previous page and try again."
                    );
                }
            } catch (error) {
                console.log("alert: ", error);
                alert(
                    "No session ID found. Please return to the previous page and try again."
                );
            }

            // dev mode
            const dev = false;
            if (dev === true) {
                console.log("dev mode");
                // console.log("currentSessionID: ", currentSessionID);
                currentSessionID = 999999;
            }

            // error handling for missing sessionId
            if (
                (currentSessionID == null || currentSessionID == NaN) &&
                dev === false
            ) {
                alert(
                    "No session ID found. Please return to the previous page and try again."
                );
            }

            const whiteboard = document.getElementById("whiteboard");
            let draggedNote = null;

            // Function to update drag & drop events for a note
            function addDragDropEvents(note) {
                note.addEventListener("dragstart", (e) => {
                    draggedNote = e.target;
                });

                note.addEventListener("dragend", (e) => {
                    draggedNote = null;
                });
            }

            // Add additional notes to the whiteboard for each note in the data structure
            for (const noteText in noteScores) {
                const note = document.createElement("div");
                note.classList.add("sticky-note");
                note.textContent = noteText;
                note.draggable = true;

                // Add drag & drop events to the new note
                addDragDropEvents(note);

                // Add the note to the sticky header
                document.getElementById("sticky-header").appendChild(note);

                // Once rendered, change to absolute positioning
                // note.style.position = "absolute";
            }

            // After all notes rendered, fix their poisitioning
            const stickyNotes = document.querySelectorAll(".sticky-note");

            whiteboard.addEventListener("dragover", (e) => {
                e.preventDefault(); // Allow dropping
            });

            whiteboard.addEventListener("drop", (e) => {
                e.preventDefault();

                if (!draggedNote) return;

                // Correcting for any potential border or padding on the whiteboard
                const boardRect = whiteboard.getBoundingClientRect();

                // Calculate the notes left and top positions as a percentage of the whiteboard width and height
                let leftPx =
                    e.clientX - boardRect.left - draggedNote.offsetWidth / 2;
                let topPx =
                    e.clientY - boardRect.top - draggedNote.offsetHeight / 2;

                // Replace the original note with a placeholder in its original location in the sticky header - maintains original grid positioning
                const placeholder = document.createElement("div");
                placeholder.classList.add("sticky-note-placeholder");
                draggedNote.parentNode.replaceChild(placeholder, draggedNote);

                let leftPercent = (leftPx / boardRect.width) * 100;
                draggedNote.style.left = leftPercent + "%";

                let topPercent = (topPx / boardRect.height) * 100;
                draggedNote.style.top = topPercent + "%";

                // Add the note to the whiteboard if it's not already there
                if (draggedNote.parentNode !== whiteboard) {
                    whiteboard.appendChild(draggedNote);
                }

                // Ensure it has absolute positioning
                draggedNote.style.position = "absolute";

                // Re-add drag & drop events in case this is a new note
                addDragDropEvents(draggedNote);

                // Once the note is placed, calculate its score
                updateNoteScore(draggedNote);
            });

            function updateNoteScore(note) {
                const noteRect = note.getBoundingClientRect();
                const boardRect = whiteboard.getBoundingClientRect();

                const noteCenterX = noteRect.left + noteRect.width / 2;
                const noteCenterY = noteRect.top + noteRect.height / 2;

                const boardCenterX = boardRect.left + boardRect.width / 2;
                const boardCenterY = boardRect.top + boardRect.height / 2;

                const relativeX = noteCenterX - boardCenterX;
                const relativeY = noteCenterY - boardCenterY;

                // Normalize the values to the range of -10 to 10
                const impactScore = (relativeX / (boardRect.width / 2)) * 10;
                const interestScore =
                    -(relativeY / (boardRect.height / 2)) * 10; // Y-axis is inverted in screen coordinates

                // Update the scores in our data structure
                noteScores[note.textContent] = {
                    impact: Math.round(impactScore),
                    interest: Math.round(interestScore),
                };

                console.log(noteScores); // For debugging purposes
            }

            // Select the continue button
            const continueButton = document.getElementById("continue-button");

            // Attach the click handler
            continueButton.addEventListener("click", handleContinueClick);

            function handleContinueClick() {
                // Placeholder for now, you can add your logic here later
                console.log("Continue button clicked!"); // For debugging purposes

                // Alert user if they haven't placed all notes
                if (
                    document.querySelectorAll(".sticky-note").length !=
                    document.querySelectorAll("#whiteboard > .sticky-note")
                        .length
                ) {
                    alert("Please place all notes before continuing");
                } else {
                    // alert("All notes placed!");
                    // Post a record to userSubmissions table woth currentSessionID and noteScores and an entryID

                    let entryID = Math.floor(Math.random() * 1000000) + 1;
                    const jsonScores = JSON.stringify(noteScores);

                    let url =
                        "https://api.sheety.co/f86a219e4c66ae9bacf55c87219398c1/activeSessions1/userSubmissions";
                    let body = {
                        usersubmission: {
                            sessionId: currentSessionID,
                            entryId: entryID,
                            noteScores: jsonScores,
                            date: new Date().toLocaleString(),
                        },
                    };

                    fetch(url, {
                        method: "POST",
                        body: JSON.stringify(body),
                        headers: {
                            "Content-Type": "application/json",
                        },
                    })
                        .then((response) => response.json())
                        .then((json) => {
                            // Update the div with the new sessionId
                            console.log("response: ", json);
                            console.log("Continue to results");
                            // Redirect to results page
                            window.location.href = `https://jackliddy.github.io/R2R-activity-1-3/results.html?sessionId=${currentSessionID}`;
                            // window.location.href = `http://127.0.0.1:5501/R2R-activity-1-3%20V2/results.html?sessionId=${currentSessionID}`;
                        })
                        .catch((error) => {
                            console.log(error);
                            alert("There was an error submitting your answer.");
                        });
                }
            }
        </script>
    </body>
</html>
