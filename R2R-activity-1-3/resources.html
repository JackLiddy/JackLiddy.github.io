<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Activity 1.3</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Poppins", sans-serif;
                /* background-color: #e6ecf0; */
                background-color: transparent;
                /* padding: 40px 0; */
            }

            .main-activity-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                margin: 15px;
                background-color: #ffffff;
                border-radius: 10px;
                padding: 5px;
                padding-bottom: 50px;
                border: 2.5px solid #854abe;
            }

            #sticky-header {
                display: flex;
                justify-content: space-evenly;
                /* padding: 20px 0; */
                /* background-color: #f4f4f4; */
                width: 85vw;
                height: 100px;
                /* margin-bottom: 25px; */

                z-index: 2;
                position: relative;
                /* top: 45px; Move it up so it overlaps the line */
                /* overflow: none; */
                /* font-size: ; */
            }

            .sticky-note {
                width: 80px;
                height: 80px;
                background-color: #ffeb3b;
                /* background-color: #ffeb3b5e; */
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                text-align: center;
                box-sizing: border-box;
                padding: 5px;
                font-size: 12px;
            }
            .sticky-note:hover {
                background-color: #ffe100; /* Darker shade of yellow to indicate it's selected */
            }
            .sorted-notes-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin: 10px;
                margin-bottom: -70px;
            }

            #whiteboard {
                width: 90vw;
                height: 450px;
                /* height: 70vh; */
                /* background-color: white; */
                /* background-color: rgb(255, 246, 209); */
                position: relative;
                /* overflow: hidden; to ensure notes don't spill out */
            }

            /* whiteboard styling */
            .container {
                display: flex;
                flex-wrap: wrap;
                position: relative;
                /* width: 400px; */
                /* height: 400px; */
                /* width: 100vw; */
                /* height: 100vh; */
                width: 100%;
                height: 100%;
            }

            .quadrant {
                display: flex;
                flex: 1 1 50%; /* grow, shrink, base size  */
                align-items: center;
                justify-content: center;
                font-weight: bold;
            }

            .green {
                background-color: #c2e597;
            }

            .blue {
                background-color: #a5d5ff;
            }

            .grey {
                background-color: #d1d1d1;
            }

            .tan {
                background-color: #ffdaa5;
            }

            .line {
                position: absolute;
                background-color: black;
            }

            .horizontal {
                width: 100%;
                height: 2px;
                top: 50%;
                transform: translateY(-50%);
            }

            .vertical {
                width: 2px;
                height: 100%;
                left: 50%;
                transform: translateX(-50%);
            }

            .arrow {
                position: absolute;
                width: 0;
                height: 0;
                border-style: solid;
            }

            .horizontal-arrow {
                left: 50%;
                bottom: -10px;
                border-width: 10px 10px 0;
                border-color: black transparent transparent transparent;
                transform: translateX(-50%);
            }

            .vertical-arrow {
                top: 50%;
                right: -10px;
                border-width: 10px 0 10px 10px;
                border-color: transparent transparent transparent black;
                transform: translateY(-50%);
            }

            /* New arrow classes for the top and left sides */
            .arrow.horizontal-arrow-top {
                left: 50%;
                top: -10px;
                border-width: 0 10px 10px;
                border-color: transparent transparent black transparent;
                transform: translateX(-50%);
            }

            .arrow.vertical-arrow-left {
                top: 50%;
                left: -10px;
                border-width: 10px 10px 10px 0;
                border-color: transparent black transparent transparent;
                transform: translateY(-50%);
            }

            .label {
                position: absolute;
                font-weight: bold;
                z-index: 10; /* Ensure labels are on top */
            }

            .horizontal-left {
                left: -82px;
                top: 50%;
                transform: translateY(-60%);
            }

            .horizontal-right {
                right: -82px;
                top: 50%;
                transform: translateY(-60%);
            }

            .vertical-top {
                /* top: 10px; */
                top: -25px;
                left: 50%;
                transform: translateX(-50%) translateY(-10%); /* Adjust the alignment */
            }

            .vertical-bottom {
                /* bottom: 10px; */
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%) translateY(10%); /* Adjust the alignment */
            }

            #arrow-line-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 90vw;
                height: 20px;
                margin: 15px 0;
                position: relative;
                z-index: 1; /* Ensure this is below the sticky header */
                top: -83px;
            }

            #arrow-line {
                width: 100%;
                height: 2px;
                background-color: black;
                position: absolute;
                top: 50%;
                left: 0;
            }

            .arrow-end {
                width: 15px;
                height: 15px;
                background-color: black;
                clip-path: polygon(100% 50%, 0% 100%, 0 0);
                clip-path: polygon(100% 50%, 0% 0%, 0% 100%);
            }

            .label-end {
                font-weight: bold;
                margin-top: 10px;

                margin-top: -11px;
                margin-bottom: 47px;
            }

            #resource-pane {
                width: 100%;
                height: 80%;
                border-radius: 35px;
                /* z-index: 1; */
                /* background-color value of rgb 181,249,156 */
                /* background-color: rgb(181, 249, 156); */
                background-color: #f0fffe;
                display: flex;
                flex-direction: column;
                /* justify-content: space-evenly; */
                align-items: center;
                padding-top: 25px;
            }

            /* style as a header */
            #resource-topic {
                font-size: 2.2rem;
                font-weight: bold;
                margin: 15px;
            }
            #resource-content {
                margin: 25px;

                /* font-size: 1.5rem;
                font-weight: bold; */
            }

            .word-list {
                display: flex;
                justify-content: space-between;
                /* font-size: 12px; */
                font-size: 1.5vw;
            }
            .word-list span:not(:last-child)::after {
                content: "|";
                margin: 0 5px;
            }
            .bold {
                font-weight: bold;
            }
        </style>
    </head>

    <body>
        <div class="main-activity-container">
            <div id="instruction-container">
                <!-- <h1>R2R Activity 1.3 (Prototype)</h1> -->

                <p>
                    Explore resources and solutions that might work for your
                    lab:
                </p>

                <ul>
                    <li>
                        What resources are available that can solve your most
                        impactful issues?
                    </li>
                    <li>
                        What solutions are your colleagues most interested in
                        trying?
                    </li>
                </ul>
                <p>
                    The sticky notes below are ordered from most high interest
                    and impact to low interest and impact. Click on each to see
                    solutions and resources for improving that issue.
                </p>
            </div>

            <div class="sorted-notes-container">
                <div id="sticky-header">
                    <!-- Add as many notes as required -->
                </div>

                <!-- New section for the arrow line and labels -->
                <div id="arrow-line-container">
                    <div class="arrow vertical-arrow"></div>
                    <div class="arrow vertical-arrow-left"></div>
                    <div class="line horizontal"></div>
                </div>

                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                        width: 92vw;
                        position: relative;
                        top: -53px;
                    "
                >
                    <div class="label-end">
                        <div class="right-label">LOW INTEREST</div>
                        <div class="right-label">LOW IMPACT</div>
                    </div>
                    <div class="label-end">
                        <div class="left-label">HIGH INTEREST</div>
                        <div class="left-label">HIGH IMPACT</div>
                    </div>
                </div>
            </div>

            <div id="whiteboard">
                <div id="resource-pane">
                    <!-- <div id="resource-topic"></div> -->
                    <div class="word-list">
                        <span id="Organization">Organization</span>

                        <span id="Documentation">Documentation</span>

                        <span id="Automation">Automation</span>
                        <span id="Dissemination">Dissemination</span>

                        <span id="Alignment">Alignment</span>

                        <span id="Containment">Containment</span>

                        <span id="Interpretation">Interpretation</span>

                        <span id="Validation">Validation</span>
                    </div>
                    <!-- <div id="resource-text"></div> -->
                    <div id="resource-content"></div>
                </div>
            </div>
            <!-- <button
                id="continue-button"
                style="
                    position: absolute;
                    bottom: 2%;
                    right: 2%;
                    padding: 10px 20px;
                "
            >
                Continue
            </button> -->
        </div>

        <script>
            // Utility to calculate the median value of a given note's linear scores
            function median(values) {
                values.sort(function (a, b) {
                    return a - b;
                });

                let half = Math.floor(values.length / 2);

                if (values.length % 2) return values[half];
                else return (values[half - 1] + values[half]) / 2.0;
            }

            // Get the current session ID from the URL
            const urlParams = new URLSearchParams(window.location.search);
            let currentSessionID = urlParams.get("sessionId");

            // dev mode
            const dev = false;
            if (dev === true) {
                console.log("dev mode");
                // console.log("currentSessionID: ", currentSessionID);
                // currentSessionID = "999999";
                currentSessionID = "510205";
            }

            // error handling for missing sessionId
            if (currentSessionID == null) {
                alert(
                    "No session ID found. Please return to the previous page and try again."
                );
            }

            // let enteredSessionId = 886254; // hardcoded test session ID

            let url = `https://api.sheety.co/f86a219e4c66ae9bacf55c87219398c1/activeSessions1/userSubmissions?filter[sessionId]=${currentSessionID}`;

            // Fetch the user submissions from the API and calculate the median note scores
            fetch(url)
                .then((response) => response.json())
                .then((json) => {
                    // If response is empty, display an error message
                    if (json.userSubmissions.length === 0) {
                        console.log("Session does not exist.");
                        // Display an error message
                    } else {
                        console.log("Session exists!");

                        console.log("Json response", json);
                        // console.log("Session exists!");

                        // log all user submissions
                        console.log(
                            "All user submissions",
                            json.userSubmissions
                        );

                        // get the note scores from each user submission
                        console.log(
                            "Note scores",
                            json.userSubmissions[0].noteScores
                        );

                        // for each user submission in the array, get the note scores
                        json.userSubmissions.forEach((userSubmission) => {
                            console.log(
                                "Note scores",
                                userSubmission.noteScores
                            );
                        });

                        // for each user submission in the array, get the note scores and add them to some data structure. Convert the json string to a json object
                        let noteScoresArray = [];
                        json.userSubmissions.forEach((userSubmission) => {
                            console.log(
                                "Note scores",
                                userSubmission.noteScores
                            );
                            let noteScoresJson = JSON.parse(
                                userSubmission.noteScores
                            );
                            noteScoresArray.push(noteScoresJson);
                        });
                        console.log("Note scores array", noteScoresArray);

                        // Create an object to store linear scores for each note
                        let linearScores = {};

                        // Calculate linear score for each note in each user submission and store them
                        noteScoresArray.forEach((noteScores) => {
                            for (let note in noteScores) {
                                if (!linearScores[note]) {
                                    linearScores[note] = [];
                                }
                                let impact = noteScores[note].impact;
                                let interest = noteScores[note].interest;
                                let linearScore = (impact + interest) / 2;
                                linearScores[note].push(linearScore);
                            }
                        });
                        console.log("Linear Scores:", linearScores);

                        // Calculate median linear score for each note
                        let medianScores = {};
                        for (let note in linearScores) {
                            medianScores[note] = median(linearScores[note]);
                        }

                        console.log("Median Linear Scores:", medianScores);

                        // Now instead of calculating the median linear score for each note, calculate the average score for each note
                        let averageNoteScores = {};
                        for (let note in linearScores) {
                            let sum = linearScores[note].reduce(
                                (a, b) => a + b,
                                0
                            );
                            let avg = sum / linearScores[note].length;
                            averageNoteScores[note] = avg;
                        }
                        console.log(
                            "Average Linear Scores:",
                            averageNoteScores
                        );

                        // Sort notes based on median linear scores and render them
                        const sortedNotes = Object.entries(medianScores)
                            .sort((a, b) => a[1] - b[1])
                            .map((entry) => entry[0]);

                        console.log("sortedNotes", sortedNotes);

                        const stickyHeader =
                            document.getElementById("sticky-header");
                        sortedNotes.forEach((noteText) => {
                            const noteElement = document.createElement("div");
                            noteElement.className = "sticky-note";
                            noteElement.textContent = noteText;
                            stickyHeader.appendChild(noteElement);
                        });

                        // Based on the current order of the sticky-header, re-order the word-list depending on the corresponding entry in dictionary noteSolutions.
                        // Get the word-list element
                        const wordList = document.querySelector(".word-list");
                        // Clear the word-list
                        wordList.innerHTML = "";
                        // For each note in the sortedNotes array, get the corresponding solution from the noteSolutions object and add it to the word-list
                        sortedNotes.forEach((note) => {
                            const solution = noteSolutions[note];
                            const span = document.createElement("span");
                            span.textContent = solution;
                            wordList.appendChild(span);
                        });

                        // add handler for sticky notes after theyve been initialized
                        document
                            .querySelectorAll(".sticky-note")
                            .forEach((note) => {
                                note.addEventListener(
                                    "mouseenter",
                                    function () {
                                        // Based on the selected note, get the resources from the notesWithResources object and display them in the resource pane
                                        // Render the resource's topic in resource-topic and the resource's text in resource-text
                                        const note =
                                            noteResources[this.textContent];

                                        // Render the resource's content in resource-content
                                        const resourceContent =
                                            document.getElementById(
                                                "resource-content"
                                            );
                                        resourceContent.innerHTML =
                                            noteResources[this.textContent];

                                        // Bolden the resource's solutions in the word list
                                        const wordList =
                                            document.querySelector(
                                                ".word-list"
                                            );
                                        // Clear all bolded words
                                        wordList
                                            .querySelectorAll("span")
                                            .forEach((span) => {
                                                span.classList.remove("bold");
                                            });
                                        // Bold the current resource's solutions
                                        const solutions =
                                            noteSolutions[this.textContent];
                                        solutions.split(" ").forEach((word) => {
                                            wordList
                                                .querySelectorAll("span")
                                                .forEach((span) => {
                                                    if (
                                                        span.textContent ===
                                                        word
                                                    ) {
                                                        span.classList.add(
                                                            "bold"
                                                        );
                                                    }
                                                });
                                        });
                                    }
                                );
                            });
                        // On page load, set the first sticky note to be selected
                        document
                            .querySelector(".sticky-note")
                            .dispatchEvent(new Event("mouseenter"));
                    }
                })
                .catch((error) => {
                    console.error(
                        "There was an error fetching the data:",
                        error
                    );
                });

            // Continue button logic
            // const continueButton = document.getElementById("continue-button");
            // continueButton.addEventListener("click", handleContinueClick);
            // function handleContinueClick() {
            //     // Placeholder for now, you can add your logic here later
            // }

            // Function to convert impact and interest values to X and Y coordinates on the whiteboard
            function getCoordinatesFromScores(impact, interest) {
                const boardRect = whiteboard.getBoundingClientRect();
                const x =
                    boardRect.width / 2 + (impact / 10) * (boardRect.width / 2);
                const y =
                    boardRect.height / 2 -
                    (interest / 10) * (boardRect.height / 2);
                return { x, y };
            }

            var noteResources = {
                "Missed mistakes": `<div>
                            <h1>Missed mistakes</h1>
                            <p>We all make mistakes! Brainstorming with your lab colleagues about approaches to check and validate your lab’s work is a great way to make your work more rigorous.</p>
                            <ul>
                                <li>Error Tight: Exercises for Lab Groups to Prevent Research Mistakes
                                    <ul>
                                        <li><a href="https://osf.io/preprints/psyarxiv/rsn5y/">https://osf.io/preprints/psyarxiv/rsn5y/</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>`,
                "Interpreting results": `<div>
                                <h1>Interpreting results</h1>
                                <p>Knowing how to appropriately report your results can be tricky - especially if there are unexpected findings. A reporting guideline can help you ensure you are reporting all the results in a systematic manner.</p>
                                <ul>
                                    <li>Reporting Guidelines
                                        <ul>
                                            <li><a href="https://www.equator-network.org/">https://www.equator-network.org/</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>`,
                "Designing experiments": `<div>
                                <h1>Designing experiments</h1>
                                <p>What are the important factors to consider when designing an experiment? Ensuring that your experiment’s rationale is aligned with the study design and the analyses helps to support the rigor of your research.</p>
                                <ul>
                                    <li>Better Inference in Neuroscience: Test Less, Estimate More
                                        <ul>
                                            <li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9665913/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9665913/</a></li>
                                        </ul>
                                    </li>
                                </ul>
                             </div>`,
                "Hard to reproduce analyses": `<div>
                                      <h1>Hard to reproduce analyses</h1>
                                      <p>Ever try to rerun an analysis and get an error? Or a different result? Computational reproducibility can be difficult. There are many ways to improve reproducibility of your analyses that also make future analyses easier for you and your lab colleagues.</p>
                                      <ul>
                                          <li>Guide for Reproducible Research
                                              <ul>
                                                  <li><a href="https://the-turing-way.netlify.app/reproducible-research/reproducible-research.html">https://the-turing-way.netlify.app/reproducible-research/reproducible-research.html</a></li>
                                              </ul>
                                          </li>
                                      </ul>
                                  </div>`,
                "Hard to find files": `<div>
                              <h1>Hard to find files</h1>
                              <p>Designing and documenting simple organization rules for your research files is easy and impactful. File naming conventions can be as simple as short set of naming rules documented in a central README file.</p>
                              <ul>
                                  <li>File Naming Conventions
                                      <ul>
                                          <li><a href="https://datamanagement.hms.harvard.edu/plan-design/file-naming-conventions">https://datamanagement.hms.harvard.edu/plan-design/file-naming-conventions</a></li>
                                      </ul>
                                  </li>
                              </ul>
                           </div>`,
                "Data loss or corruption": `<div>
                                   <h1>Data loss or corruption</h1>
                                   <p>Data loss or corruption can be a common source of irreproducible research, not to mention headaches and wasted time. Many researchers consider using data repositories to share data after a publication. However, many repositories can be used as a backup and a way to preserve access for your lab colleagues and your future self.</p>
                                   <ul>
                                       <li>Registry of research data repositories
                                           <ul>
                                               <li><a href="https://www.re3data.org/">https://www.re3data.org//a></li>
                                           </ul>
                                       </li>
                                       <li>Data repositories
                                           <ul>
                                               <li><a href="https://datamanagement.hms.harvard.edu/share-publish/data-repositories">https://datamanagement.hms.harvard.edu/share-publish/data-repositories</a></li>
                                           </ul>
                                       </li>
                                   </ul>
                               </div>`,
                "Deviating from lab protocols": `<div>
                                        <h1>Deviating from lab protocols</h1>
                                        <p>Deviation from a protocol in a study can lead to biased results. In large labs or complex studies, you may have multiple people working on the same method. Ensuring that they are doing the same thing can improve the rigor of your research.</p>
                                        <ul>
                                            <li>Protocol checklists
                                                <ul>
                                                    <li><a href="https://www.protocols.io/">https://www.protocols.io/</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>`,
                "Difficult onboarding and offboarding": `<div>
                                               <h1>Difficult onboarding and offboarding</h1>
                                               <p>Onboarding new lab colleagues can be time consuming for current members and frustrating for new members. Offboarding is often an afterthought, with files and methods and data leaving along with lab colleagues. An electronic laboratory notebook is one way to improve documentation of important aspects of your lab protocols, data, and systems.</p>
                                               <ul>
                                                   <li>How to pick an electronic laboratory notebook
                                                       <ul>
                                                           <li><a href="https://www.nature.com/articles/d41586-018-05895-3">https://www.nature.com/articles/d41586-018-05895-3</a></li>
                                                       </ul>
                                                   </li>
                                               </ul>
                                           </div>`,
            };

            let noteSolutions = {
                "Missed mistakes": "Validation",
                "Interpreting results": "Interpretation",
                "Designing experiments": "Alignment",
                "Hard to reproduce analyses": "Automation",
                "Hard to find files": "Organization",
                "Data loss or corruption": "Dissemination",
                "Deviating from lab protocols": "Containment",
                "Difficult onboarding and offboarding": "Documentation",
            };
        </script>
    </body>
</html>
