<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Lab Presentation Form</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                /* background-color: #933c3c; */
                /* color: black; */
                padding: 20px;

                display: flex;
                flex-direction: column;
                background-color: black;
            }
            .question-container {
                width: 380px;
                background-color: #ffffff;
                padding: 20px;
                position: relative;
                height: 216px;
                margin-left: 90px;
                padding-left: 191px;
                padding-left: 90px;
                border-radius: 10px;

                /* display: none; */
            }

            .question-content {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
            }
            .thank-you-content {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
                display: none;
            }

            .header {
                padding-top: 0px;
                /* padding: 10px 0; */
                /* border-bottom: 1px solid #555; */
            }
            #top-img {
                position: absolute;
                left: -131px;
                top: -1px;
                height: 101%;
                z-index: 1;
            }

            .question {
                -webkit-text-stroke: 1.5px white;
                font-size: 2em;
                font-weight: bolder;
                z-index: 2;
            }
            .question h2 {
                margin-top: 0px;
            }
            .thank-you-msg {
                -webkit-text-stroke: 1.5px white;
                font-size: 2em;
                font-weight: bolder;
                z-index: 2;
            }

            .student-selection-container {
                width: 380px;
                background-color: #ffffff;
                padding: 20px;
                border-radius: 10px;
                /* position: absolute; */
                /* height: 216px; */
                /* margin-left: 90px; */
                /* padding-left: 191px; */
                /* padding-left: 90px; */

                display: none;
            }

            .answer-container {
                display: flex;
                border-radius: 10px;

                width: 520px;
                margin: 10px;
                padding: 22px;
                background-color: white;
                flex-direction: column;
                align-items: center;
                overflow: hidden;
            }

            #answer-input-area {
                width: 90%;
                /* margin: 10px; */
                background-color: #d9d9d9;
                margin-bottom: 10px;
                padding: 24px;
            }
            .textarea-container {
                position: relative;
                /* width: 300px; */
                width: 100%;
            }

            /* textarea {
    width: 100%;
    height: 100px;
    padding: 10px;
    box-sizing: border-box;
    resize: vertical;
} */

            #charCount {
                position: absolute;
                bottom: 29px;
                right: 10px;
                font-size: 14px;
                color: #888;
            }

            #answer-footer {
                display: flex;
                flex-direction: row;
                width: 100%;
                justify-content: flex-start;
            }

            .footer-img {
                /* width: 400px; */
                /* position: relative; */
            }

            .submit-answer-btn {
            }

            .submit-answer-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                width: 85%;
                height: 90px;
            }
            /* hover */
            .submit-answer-btn:hover {
                background-color: #5e2d8a;
                color: white;
            }
            /* clicked */
            .submit-answer-btn:active {
                background-color: #49226b;
                color: white;
            }
            #computer-raven-img {
                position: absolute;
                width: 143px;
                left: 472px;
                /* top: 615px; */
                top: 507px;
            }

            .student-select-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                /* padding: 10px; */
                margin-bottom: 10px;
            }

            #student-selection-dropdown {
                padding: 5px;
                border-radius: 10px;
                display: none;
            }


            .preview-container {
                /* display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                margin-bottom: 10px; */

                display: flex;
    border-radius: 10px;
    width: 520px;
    margin: 10px;
    padding: 22px;
    background-color: rgba(255, 255, 255, 0);
    flex-direction: column;
    align-items: center;

    display: none;
            }

            .response-container {
                width: 593px;
                padding: 11px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
            }
            .response {
                background-color: #5e2d8a;
                width: 100%;
                margin: 10px;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                background-color: #ffffff;

                height: 128px;
                 border-radius: 10px;
            }
            .response h3 {
                text-align: center;
                font-weight: normal;
            }
            .arrow {
                position: absolute;
                width: 0;
                height: 0;
                border-style: solid;

                position: relative;
                width: 0;
                height: 0;
                border-style: solid;
                margin: -11px;
            }
            .arrow.horizontal-arrow-top {
                left: 50%;
                top: -10px;
                border-width: 0 10px 10px;
                border-color: transparent transparent black transparent;
                transform: translateX(-50%);

                left: 312px;
                top: -11px;
                border-width: 0 15px 42px;
                border-color: transparent transparent white transparent;
                transform: translateX(-50%);
            }
            .member-dropdown {
                display: none;
            }

































            @media only screen and (max-width: 600px) {
                body {
                font-family: Arial, sans-serif;
                /* background-color: #933c3c; */
                /* color: black; */
                padding: 0px;
                margin: 0px;
                display: flex;
                flex-direction: column;
                background-color: rgb(0, 0, 0);
                width: 100vw;
                justify-content: flex-start;
                align-items: center;
                margin-top: 5px;;
                

            }
            .question-container {
                /* width: 380px; */
                background-color: #ffffff;
                padding: 0px;
                position: inherit;
                height: 25vh;
                margin-left: 0px;
                padding-left: 0px;
                padding-left: 0px;
                border-radius: 10px;
                width: 90vw;


                /* display: none; */
            }

            .question-content {
                display: flex;
    flex-direction: row-reverse;
    align-items: center;
    text-align: center;
    justify-content: space-between;
            }
            .thank-you-content {
                /* display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center; */

                display: flex;
    flex-direction: row-reverse;
    align-items: center;
    text-align: center;
    justify-content: space-between;




                display: none;
            }

            .header {
                padding-top: 0px;
                /* padding: 10px 0; */
                /* border-bottom: 1px solid #555; */
            }
            #top-img {
    /* position: relative; */
    left: 0px;
    top: 0px;

    position: relative;

    left: -22px;
    top: 0px;

    position: relative;

    width: 80%;
    width: 68vw;
            }

            .top-img-container {
                width: 10vw;
            }

            .question {
                -webkit-text-stroke: 1.5px white;
                font-size: 1.5em;
                font-weight: bolder;
                z-index: 2;

                margin-left: 56px;
            }
            .question h2 {
                margin-top: 0px;
            }
            .thank-you-msg {
                -webkit-text-stroke: 1.5px white;
                font-size: 2em;
                font-weight: bolder;
                z-index: 2;
            }
            .thank-you-msg h2 {
                margin-top: 0px;
            }

            .student-selection-container {
                width: 380px;
                background-color: #ffffff;
                padding: 20px;
                border-radius: 10px;
                /* position: absolute; */
                /* height: 216px; */
                /* margin-left: 90px; */
                /* padding-left: 191px; */
                /* padding-left: 90px; */

                display: none;
            }

            .answer-container {
                display: flex;
                border-radius: 10px;

                width: 520px;
                margin: 10px;
                padding: 22px;
                background-color: white;
                flex-direction: column;
                align-items: center;

                width: 90vw;
                margin: 5px;
                padding: 5px;
                background-color: white;
                flex-direction: column;
                align-items: center;    
                justify-content: center;

                height: 50vh;  

            }

            #answer-input-area {
                width: 85%;
                /* margin: 10px; */
                background-color: #d9d9d9;
                margin-bottom: 10px;
                padding: 24px;
                border-radius: 10px;
            }
            .textarea-container {
                /* position: relative; */
                /* width: 300px; */
                width: 95%;
                display: flex;
                flex-direction: column;
    align-content: center;
    justify-content: flex-start;
    align-items: center;
    /* border-radius: 15px; */
            }

            /* textarea {
    width: 100%;
    height: 100px;
    padding: 10px;
    box-sizing: border-box;
    resize: vertical;
} */

            #charCount {
                position: relative;
                /* bottom: 29px;
                right: 10px; */
                font-size: 14px;
                color: #888;
                right: -30%;
            }

            #answer-footer {
                display: flex;
                flex-direction: row;
                width: 100%;
                justify-content: flex-start;

                    padding-top: 16px;
                    align-items: flex-start;

            }

            .footer-img {
                /* width: 400px; */
                /* position: relative; */
                width: 10px;
                height: 10px;
            }

            .submit-answer-btn {
            }

            .submit-answer-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                width: 85%;
                height: 90px;
            }
            /* hover */
            .submit-answer-btn:hover {
                background-color: #5e2d8a;
                color: white;
            }
            /* clicked */
            .submit-answer-btn:active {
                background-color: #49226b;
                color: white;
            }
            #computer-raven-img {
                position: relative;
    width: 143px;
    left: -86px;
    top: -18px;
            }

            .student-select-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                /* padding: 10px; */
                margin-bottom: 10px;
            }

            #student-selection-dropdown {
                padding: 5px;
                border-radius: 10px;
                display: none;
            }


            .preview-container {
                /* display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                margin-bottom: 10px; */

                display: flex;
    border-radius: 10px;
    width: 100%;
    margin: 10px;
    padding: 22px;
    background-color: rgba(255, 255, 255, 0);
    flex-direction: column;
    align-items: center;

    display: none;
            }

            .response-container {
                width: 95vw;
                padding: 11px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
            }
            .response {
                background-color: #5e2d8a;
                width: 90vw;
                margin: 10px;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                background-color: #ffffff;

                height: 128px;
                 border-radius: 10px;
            }
            .response h3 {
                text-align: center;
                font-weight: normal;
            }
            .arrow {
                position: absolute;
                width: 0;
                height: 0;
                border-style: solid;

                position: relative;
                width: 0;
                height: 0;
                border-style: solid;
                margin: -11px;
                display: none;
            }
            .arrow.horizontal-arrow-top {
                left: 50%;
                top: -10px;
                border-width: 0 10px 10px;
                border-color: transparent transparent black transparent;
                transform: translateX(-50%);

                left: 312px;
                top: -11px;
                border-width: 0 15px 42px;
                border-color: transparent transparent white transparent;
                transform: translateX(-50%);
                left: 201px;
                display: none;
            }
            .member-dropdown {
                display: none;
            }
}



        </style>
    </head>
    <body>
        <div class="question-container">
            <div class="question-content">
                <div class="question">
                    <h2>QUESTION HERE</h2>
                </div>
                <div class="top-img-container">
                    <img
                    id="top-img"
                    src="raven-white-bg-08.svg"
                    alt=""
                    width="400"
                    height="400"
                />
                </div>
                <!-- <img
                    id="top-img"
                    src="raven-white-bg-08.svg"
                    alt=""
                    width="400"
                    height="400"
                /> -->

            </div>
            <div class="thank-you-content">
                <div class="thank-you-msg">
                    <h2>Thank you for participating!</h2>
                </div>

                <div class="top-img-container">
                    <img
                    id="top-img"
                    src="raven-white-bg-08.svg"
                    alt=""
                    width="400"
                    height="400"
                />
                </div>
                
                <!-- <img
                    id="top-img"
                    src="raven-white-bg-08.svg"
                    alt=""
                    width="400"
                    height="400"
                /> -->
            </div>
        </div>

        <div class="answer-container">
            <div class="student-select-container">
                <p>
                    Select your name from the dropdown menu below to submit your
                    answer to the question.
                </p>

                <!-- dropdown -->
                <select
                    id="student-selection-dropdown"
                    name="student-selection-dropdown"
                >
                    <option value="" disabled selected hidden>
                        Lab Members
                    </option>
                    <!-- <option value="student1">Student 1</option>
                <option value="student2">Student 2</option>
                <option value="student3">Student 3</option>
                <option value="student4">Student 4</option> -->
                </select>
            </div>

            <!-- <div id="answer-input-area"> -->
            <!-- text area here -->
            <!-- <textarea
                name="answer"
                id="answer-input-area"
                cols="30"
                rows="10"
                placeholder="Enter your answer here..."
            ></textarea> -->
            <div class="textarea-container">
                <textarea
                    id="answer-input-area"
                    cols="30"
                    rows="10"
                    placeholder="Enter your answer here..."
                    maxlength="140"
                    oninput="updateCharacterCount()"
                ></textarea>
                <div id="charCount">0/140 characters</div>
            </div>

            <!-- </div> -->
            <div id="answer-footer">
                <!-- submit button and raven -->
                <button class="submit-answer-btn" onclick="handleSubmit()">
                    Submit
                </button>
                <div class="footer-img">
                    <img
                        id="computer-raven-img"
                        src="raven-white-bg-11.svg"
                        alt=""
                    />
                </div>
            </div>
        </div>
        <div class="preview-container">
            <!-- answer-preview-bubble -->

            <div class="response-container">
            </div>
            <!-- edit-button-container -->
            <div class="edit-button-container">
            </div>
        </div>
        <div class="edit-container">
            
        </div>        


        <script>
            // Fetch lab session code form parameter
            // Fetch question from parameter
            const urlParams = new URLSearchParams(window.location.search);
            const labSession = urlParams.get("labSession");
            const question = urlParams.get("question");
            console.log("question: ", question);
            console.log("labSession: ", labSession);


            // const anonymous = urlParams.get("anonymous");
            const anonymous = true;
            // If anonymous mode is on, hide the student selection container
            if (anonymous){
                document.querySelector(".student-select-container").style.display = "none";
            }


            // Set question text
            document.querySelector(".question h2").innerText = question;

            // Fetch lab members from database
            let url = `https://api.sheety.co/f86a219e4c66ae9bacf55c87219398c1/c4RLabPrefill/table1?filter[labId]=${labSession}`;
            fetch(url)
                .then((response) => response.json())
                .then((json) => {
                    let labExists = true;
                    console.log("json.table1: ", json.table1);

                    // If at least one lab session exists
                    if (json.table1.length > 0) {
                        console.log("json.table1.length: ", json.table1.length);

                        const sessionData = json.table1[0];

                        const labData = JSON.parse(sessionData.labData);
                        console.log(
                            "labData: ",
                            labData["nonPresentingMembers"]
                        );

                        // If lab session is not anonymous, display dropdown menu
                        if( !anonymous ) {
                            // Display the non-presenting members in a dropdown menu
                            const nonPresentingMembers =
                                labData["nonPresentingMembers"];
                            console.log(
                                "nonPresentingMembers: ",
                                nonPresentingMembers
                            );

                            // Populate the dropdown menu with the non-presenting members
                            const dropdown = document.getElementById(
                                "student-selection-dropdown"
                            );
                            nonPresentingMembers.forEach((member) => {
                                console.log("member: ", member);
                                const option = document.createElement("option");
                                option.value = member.name;
                                option.text = member.name;
                                dropdown.appendChild(option);
                            });
                        }
                    }

                    if (labExists) {
                        console.log("Lab exists!");
                    } else {
                        console.log("Lab does not exist.");
                    }
                    console.log(json.table1);
                })
                .catch((error) => {
                    // Display error message and manual entry form
                    console.error(
                        "There was an error fetching the data:",
                        error
                    );
                });

            function handleSubmit() {

                // Assign student value if not anonymous
                let selectedStudent = "";
                if (anonymous){
                    selectedStudent = "Anonymous";
                }
                else{
                     // Check if student has been selected from dropdown
                    const dropdown = document.getElementById(
                        "student-selection-dropdown"
                    ); 
                    selectedStudent = dropdown.value;
                }
                console.log("selectedStudent: ", selectedStudent);

                // handle empty case
                if (selectedStudent == "") {
                    alert("Please select your name from the dropdown menu.");
                } else {
                    // Check if answer has been entered
                    const answer =
                        document.getElementById("answer-input-area").value;
                    console.log("answer: ", answer);
                    // handle empty case
                    if (answer == "") {
                        alert("Please enter your answer in the text area.");
                    } else {
                        // Submit answer to database
                        // Fetch lab session code form parameter
                        // Fetch question from parameter
                        // const urlParams = new URLSearchParams(window.location.search);
                        // const labSession = urlParams.get("labSession");
                        // const question = urlParams.get("question");

                        // console.log('question: ', question);
                        // console.log('labSession: ', labSession);

                        // let labID = Math.floor(Math.random() * 1000000) + 1;
                        let url =
                            "https://api.sheety.co/f86a219e4c66ae9bacf55c87219398c1/c4RLabPrefill/submissions";
                        let body = {
                            submission: {
                                labId: labSession,
                                userName: selectedStudent,
                                question: question,
                                answer: answer,
                                date: new Date().toLocaleString(),
                            },
                        };
                        fetch(url, {
                            method: "POST",
                            body: JSON.stringify(body),
                            headers: {
                                "Content-Type": "application/json",
                            },
                        })
                            .then((response) => response.json())
                            .then((json) => {
                                // Update the div with the new sessionId
                                console.log("response: ", json);
                                console.log("Submitted Data to server");
                                // alert("Submitted Data to server");

                                // TODO: Move below to other function

                                // Swap out the question container with thank you message and raven
                                document.querySelector(
                                    ".question-content"
                                ).style.display = "none";
                                document.querySelector(
                                    ".thank-you-content"
                                ).style.display = "flex";

                                // Swap out the answer container with the preview container
                                document.querySelector(
                                    ".answer-container"
                                ).style.display = "none";
                                document.querySelector(
                                    ".preview-container"
                                ).style.display = "flex";

                                // Render the response in the container
                                const responseContainer = document.querySelector(
                                    ".response-container"
                                );
                                const response =
                                    document.createElement("response");

                                response.innerHTML = `
                                        <h3>${answer}</h3>
                                        <div class="arrow horizontal-arrow-top"></div>

                                `;
                                response.className = "response";
                                responseContainer.appendChild(response);
                                
                            })
                            .catch((error) => {
                                console.log(error);
                                alert(
                                    "There was an error submitting your answer."
                                );
                            });

                        // // Set question text
                        // document.querySelector(".question h2").innerText = question;
                        console.log("end");
                    }
                }
            }

            // Updates remaining character count in text area
            function updateCharacterCount() {
                const textArea = document.getElementById("answer-input-area");
                const charCount = document.getElementById("charCount");

                // const charsLeft = 140 - textArea.value.length;
                const charsUsed = textArea.value.length;
                charCount.textContent = `${charsUsed}/140 characters`;
            }
        </script>
    </body>
</html>
