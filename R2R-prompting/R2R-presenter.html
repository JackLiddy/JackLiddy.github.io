<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Lab Presentation Form</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #000000;
                padding: 20px;
            }
            .container {
                width: 348px;
                background-color: #ffffff;
                padding: 20px;
                position: relative;
                height: 216px;
                margin-left: 90px;
                padding-left: 156px;
            }

            .content {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
            }

            .header {
                padding-top: 0px;
            }
            img {
                position: absolute;
                left: -177px;
                top: -1px;
                height: 101%;
            }

            .generate-link-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
            }
            /* hover */
            .generate-link-btn:hover {
                background-color: #5e2d8a;
                color: white;
                padding: 13px;
            }
            /* clicked */
            .generate-link-btn:active {
                background-color: #49226b;
                color: white;
            }

            .start-content {
                display: none;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
            }

            .lab-content {
                display: none;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
            }
            .link-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 10px;
            }
            .start-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 10px;
            }
            .start-btn:hover {
                background-color: #5e2d8a;
                color: white;
                padding: 13px;
            }

            .button-footer {
                display: flex;
                flex-direction: row;
                align-items: center;
                text-align: center;
            }
            .countdown-btn {
                border-radius: 15px;
                background-color: #dd8b3c;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 10px;
            }
            .done-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 10px;
            }

            .time-up-content {
                display: none;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
            }
            .time-up-btn {
                border-radius: 15px;
                background-color: #dd8b3c;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 10px;
            }
            .show-answers-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 5px;
            }
            .extend-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 10px;
            }

            .outer-window {
                display: flex;
                flex-direction: column;
            }
            .response-container {
                width: 593px;
                padding: 11px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
            }
            .response {
                background-color: #5e2d8a;
                width: 100%;
                margin: 10px;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                background-color: #ffffff;
            }

            .arrow {
                position: absolute;
                width: 0;
                height: 0;
                border-style: solid;

                position: relative;
                width: 0;
                height: 0;
                border-style: solid;
                margin: -11px;
            }
            .arrow.horizontal-arrow-top {
                left: 50%;
                top: -10px;
                border-width: 0 10px 10px;
                border-color: transparent transparent black transparent;
                transform: translateX(-50%);

                left: 312px;
                top: -11px;
                border-width: 0 15px 42px;
                border-color: transparent transparent white transparent;
                transform: translateX(-50%);
            }
            .hide-answers-btn {
                border-radius: 15px;
                background-color: #854abe;
                color: white;
                font-size: x-large;
                border-width: inherit;
                padding: 12px;
                font-weight: bold;
                margin: 5px;
                display: none;
            }

            .tooltip {
                position: relative;
                display: inline-block;
            }

            .tooltip .tooltiptext {
                visibility: hidden;
                width: 140px;
                background-color: #555;
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 5px;
                position: absolute;
                z-index: 1;
                bottom: 100%;
                left: 50%;
                margin-left: -75px;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .tooltip .tooltiptext::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: #555 transparent transparent transparent;
            }

            .tooltip:hover .tooltiptext {
                visibility: visible;
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div class="outer-window">
            <div class="container">
                <div class="content">
                    <div class="header">
                        <h2>Time to hear your thoughts!</h2>
                    </div>

                    <p>
                        Click the button below to generate a link/code your lab
                        mates can use to participate in the lesson by offering
                        their own answers.
                    </p>

                    <button class="generate-link-btn">
                        Generate Link/Code
                    </button>

                    <div class="raven">
                        <img
                            src="raven-white-bg-04 (2).svg"
                            alt=""
                            width="400"
                            height="400"
                        />
                    </div>
                </div>

                <div class="start-content">
                    <div class="header">
                        <h2>Time to hear your thoughts!</h2>
                    </div>

                    <p>
                        Click the button below to generate a link/code your lab
                        mates can use to participate in the lesson by offering
                        their own answers.
                    </p>

                    <div class="button-footer">
                        <div class="tooltip">
                            <button
                                class="link-btn"
                                id="copy-to-clipboard-btn"
                                onmouseout="handleMouseOut()"
                                onclick="onLinkClick()"
                            >
                                <span class="tooltiptext" id="myTooltip"
                                    >Copy to clipboard</span
                                >
                                Copy link
                            </button>
                        </div>

                        <button class="start-btn" onclick="startLab()">
                            Start
                        </button>
                    </div>

                    <div class="raven">
                        <img
                            src="raven-white-bg-09.svg"
                            alt=""
                            width="400"
                            height="400"
                        />
                    </div>
                </div>

                <div class="lab-content">
                    <div class="header" id="question-text">
                        <h2>Question Here</h2>
                    </div>

                    <p>(Answer on your own device)</p>

                    <div class="button-footer">
                        <button class="countdown-btn">Countdown</button>
                        <button class="done-btn">Done</button>
                    </div>

                    <div class="raven">
                        <img
                            src="raven-white-bg-09.svg"
                            alt=""
                            width="400"
                            height="400"
                        />
                    </div>
                </div>

                <div class="time-up-content">
                    <div class="header" id="question-text">
                        <h2>Thanks for participating!</h2>
                    </div>

                    <div class="button-footer">
                        <button class="time-up-btn">Time Up!</button>
                        <button class="extend-btn" onclick="extendTime()">
                            Extend
                        </button>
                    </div>
                    <button class="show-answers-btn" onclick="showAnswers()">
                        Show Answers
                    </button>
                    <button class="hide-answers-btn" onclick="hideAnswers()">
                        Hide Answers
                    </button>

                    <div class="raven">
                        <img
                            src="raven-white-bg-09.svg"
                            alt=""
                            width="400"
                            height="400"
                        />
                    </div>
                </div>
            </div>

            <!-- render responses here -->
            <div class="response-container">
                <!-- <div class="response">
                    <h3>Response 1 </h3>
                    <p>Answer 1</p> 
                    <div class="arrow horizontal-arrow-top"></div>
                </div>
                </div> -->
            </div>
        </div>

        <script>
            // Get button element
            const generateLinkBtn =
                document.querySelector(".generate-link-btn");

            let labId = "";

            // Add event listener
            generateLinkBtn.addEventListener("click", () => {
                const cookieValue = checkCookie();
                if (cookieValue) {
                    // alert("Cookie exists");
                    // alert(cookieValue);
                    // Generate link

                    // Check API to see if lab session exists
                    // If it does, generate link
                    // If it doesn't, give error message about lab not being pre-filled
                    showLink(cookieValue);
                } else {
                    alert("Cookie does not exist");
                    // Handle manual entry of lab ID
                }
            });

            function checkCookie() {
                var name = "labID=";
                var decodedCookie = decodeURIComponent(document.cookie);
                var ca = decodedCookie.split(";");
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) === " ") {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) === 0) {
                        var value = c.substring(name.length, c.length);
                        // alert('Cookie "username" exists with value: ' + value);
                        labId = value;
                        return value;
                    }
                }
                return false;
                // alert('Cookie "labID" does not exist!');
            }

            function showLink(labID) {
                // Check if lab session exists
                let url =
                    "https://api.sheety.co/f86a219e4c66ae9bacf55c87219398c1/c4RLabPrefill/table1";
                fetch(url)
                    .then((response) => response.json())
                    .then((json) => {
                        let labExists = json.table1.some(
                            (entry) => entry.labId == labID
                        );
                        if (labExists) {
                            console.log("Lab exists!");
                            // Display link and start button

                            // Replace content pane with link and start button

                            // Hide the content pane
                            const content = document.querySelector(".content");
                            content.style.display = "none";
                            console.log("content pane hidden");

                            // Display the lab content pane
                            const labContent =
                                document.querySelector(".start-content");
                            labContent.style.display = "flex";
                            labContent.style.justifyContent = "space-between";
                            labContent.style.height = "100%";

                            // Set link button text to link
                            const linkBtn = document.querySelector(".link-btn");
                            // linkBtn.innerHTML = `${labID}`;
                        } else {
                            console.log("Lab does not exist.");
                            // Display error and manual entry form
                        }
                        console.log(json.table1);
                    })
                    .catch((error) => {
                        // Display error message and manual entry form
                        console.error(
                            "There was an error fetching the data:",
                            error
                        );
                    });

                // If it doesnt, display error and show manual entry form
                // If it does
                // Replace content pane with link and start button
                // Add event listeners
                // Link should be copied to clipboard when clicked
                // Start button should start the lab
                // StartLab() function should be called
            }

            function showManualEntry() {
                // Replace content pane with manual entry form and back button
                // Explain a cookie of the lab session could not be detected. Please enter the lab ID manually.
            }

            function onLinkClick() {
                console.log("link clicked");
                // let enteredSessionId = parseInt(
                //     document.getElementById("session-id-input").value
                // );

                // let newSessionId = enteredSessionId + 1;

                const urlParams = new URLSearchParams(window.location.search);
                const question = urlParams.get("question");


                let sessionLink = `https://jackliddy.github.io/R2R-prompting/R2R-audience.html?labSession=${labId}&question=${question}`;
                navigator.clipboard.writeText(sessionLink);

                // visual feedback of copy operation
                let tooltip = document.getElementById("myTooltip");
                tooltip.innerHTML = "Copied Link";
            }

            function handleMouseOut() {
                var tooltip = document.getElementById("myTooltip");
                tooltip.innerHTML = "Copy to clipboard";
            }

            function startLab() {
                // Replace Raven image with raven-white-bg-09.svg
                // const raven = document.querySelector('.raven');
                // raven.innerHTML = '<img src="raven-white-bg-09.svg" alt="" width="400" height="400">';
                console.log("raven image replaced");

                // Replace content pane with lab content
                // Question
                // Subheading
                // Countdown timer
                // Done button

                // Hide the content pane
                const content = document.querySelector(".start-content");
                content.style.display = "none";
                console.log("content pane hidden");

                // Display the lab content pane
                const labContent = document.querySelector(".lab-content");
                labContent.style.display = "flex";
                labContent.style.justifyContent = "space-between";
                labContent.style.height = "100%";

                // Fetch the question from the URL parameter 'question'
                const urlParams = new URLSearchParams(window.location.search);
                const question = urlParams.get("question");
                // Display the question
                const questionText = document.querySelector("#question-text");
                questionText.innerHTML = "<h2>" + question + "</h2>";
                console.log("question", question);
                console.log("question displayed");

                // Add event listener to countdown button
                const countdownBtn = document.querySelector(".countdown-btn");

                // Add event listener to done button
                const doneBtn = document.querySelector(".done-btn");
                doneBtn.addEventListener("click", () => {
                    // On done state - Possibly add to new function
                    // Replace timer with "Time Up"
                    // Add extend button
                    // Add show answers button

                    // Hide the lab content (question) pane
                    const content = document.querySelector(".lab-content");
                    content.style.display = "none";
                    console.log("lab pane hidden");

                    // Display the time-up content pane
                    const labContent =
                        document.querySelector(".time-up-content");
                    labContent.style.display = "flex";
                    labContent.style.justifyContent = "space-between";
                    labContent.style.height = "100%";
                });
            }

            function showAnswers() {
                // Fetch all answers from backend
                // From answers table, select all answers with the same lab ID
                // Add additional content panes below to render each answer

                let url = `https://api.sheety.co/f86a219e4c66ae9bacf55c87219398c1/c4RLabPrefill/submissions?filter[labId]=${labId}`;
                fetch(url)
                    .then((response) => response.json())
                    .then((json) => {
                        console.log("json: ", json);
                        console.log("json.submissions: ", json.submissions);

                        // If at least one lab session exists
                        if (json.submissions.length > 0) {
                            console.log(
                                "json.submissions.length: ",
                                json.submissions.length
                            );

                            // Fetch non-presenting lab members from sessionData

                            const submissions = json.submissions;

                            // Render a response in the container for each submission
                            const responseContainer = document.querySelector(
                                ".response-container"
                            );

                            submissions.forEach((submission) => {
                                console.log("submission: ", submission);
                                const response =
                                    document.createElement("response");

                                response.innerHTML = `
                                <h3>${submission.answer}</h3>
                                <div class="arrow horizontal-arrow-top"></div>
                                `;
                                response.className = "response";
                                responseContainer.appendChild(response);
                            });

                            // Toggle hide/show answers

                            const showAnswersBtn =
                                document.querySelector(".show-answers-btn");
                            showAnswersBtn.style.display = "none";

                            const hideAnswersBtn =
                                document.querySelector(".hide-answers-btn");
                            hideAnswersBtn.style.display = "flex";
                        } else {
                            console.log("No lab sessions exist with that ID");
                        }
                    })
                    .catch((error) => {
                        // Display error message and manual entry form
                        console.error(
                            "There was an error fetching the data:",
                            error
                        );
                    });
            }

            function hideAnswers() {
                // Remove all answers from the container
                const responseContainer = document.querySelector(
                    ".response-container"
                );
                responseContainer.innerHTML = "";

                // Toggle hide/show answers
                const showAnswersBtn =
                    document.querySelector(".show-answers-btn");
                showAnswersBtn.style.display = "flex";

                const hideAnswersBtn =
                    document.querySelector(".hide-answers-btn");
                hideAnswersBtn.style.display = "none";
            }

            function extendTime() {
                console.log("time extended");
            }
        </script>
    </body>
</html>
